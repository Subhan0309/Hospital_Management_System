<div class="container my-5">
  <div class="card shadow-lg">
    <div class="card-header bg-secondary d-flex justify-content-between align-items-center">
      <h5 class="text-light">My Profile</h5>
      <div>
        <button id="edit-button" class="btn btn-outline-light">Update</button>
      </div>
    </div>
    
    <div class="card-body">


      <% if current_user.doctor? %>
      <%= form_with(url: update_availability_status_doctor_path(@user), method: :patch, remote: true, id: 'availability-status-form') do |form| %>
        <%= form.hidden_field :availability_status, id: 'availability_status_field', value: @user.availability_status %>
        <div class="w-25 d-flex align-items-center justify-content-between">
          <small class="text-muted">Unavailable</small>
          <label class="switch">
            <input type="checkbox" id="availability-switch" <%= 'checked' if @user.availability_status == 'available' %>>
            <span class="slider round"></span>
          </label>
          <small class="text-muted">Available</small>
        </div>
        <%= form.submit 'Update Status', style: 'display: none;' %>
      <% end %>
    <% end %>



      <%= form_for @user, url: user_path(@user), html: { method: :patch, id: 'profile-form' }, multipart: true do |f| %>
        <%= render "devise/shared/error_messages", resource: @user %>
        <!-- Profile Picture Upload and Preview -->
        <div class="form-group mb-3 text-center">
          <% if @user.profile_picture.attached? %>
            <%= image_tag @user.profile_picture, id: 'profile-picture-preview', class: 'rounded-circle shadow', size: '150x150' %>
          <% else %>
            <%= image_tag 'default-profile.jpeg', id: 'profile-picture-preview', class: 'rounded-circle shadow', size: '150x150' %>
          <% end %>
          <br>
          <%= f.file_field :profile_picture, accept: 'image/*', class: 'form-control mt-3', style: 'display: none;' %>
        </div>

        <div class="form-group mb-3">
          <%= f.label :name, class: "form-label text-primary" %>
          <%= f.text_field :name, class: 'form-control', readonly: true %>
        </div>
        
        <div class="form-group mb-3">
          <%= f.label :email, class: "form-label text-primary" %>
          <%= f.email_field :email, class: 'form-control', readonly: true %>
        </div>

        <div class="form-group mb-3">
          <%= f.label :role, class: "form-label text-primary" %>
          <%= f.text_field :role, class: 'form-control', readonly: true %>
        </div>

        <div class="form-group mb-3">
          <%= f.label :gender, class: "form-label text-primary" %>
          <%= f.select :gender, [['Male', 'male'], ['Female', 'female']], { include_blank: 'Select Gender' }, class: 'form-control', readonly: true %>
        </div>

        <!-- Display additional details if present or allow new details to be added -->
        <% if current_user.doctor? || current_user.patient? %>
          <div class="form-group mb-3">
            <%= f.fields_for :detail_attributes, @details.first_or_initialize do |detail_fields| %>
              <% if current_user.doctor? %>
                <div class="form-group mb-3">
                  <%= detail_fields.label :qualification, class: "form-label text-primary" %>
                  <%= detail_fields.text_field :qualification, class: 'form-control', readonly: true %>
                </div>

                <div class="form-group mb-3">
                  <%= detail_fields.label :specialization, class: "form-label text-primary" %>
                  <%= detail_fields.text_field :specialization, class: 'form-control', readonly: true %>
                </div>
              <% elsif current_user.patient? %>
                <div class="form-group mb-3">
                  <%= detail_fields.label :disease, class: "form-label text-primary" %>
                  <%= detail_fields.text_field :disease, class: 'form-control', readonly: true %>
                </div>
              <% end %>
              

              
            <% end %>
          </div>
        <% end %>

        <div class="text-center">
          <%= f.submit "Save", class: "btn btn-outline-success", id: "save-button", style: "display: none;" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const editButton = document.getElementById('edit-button');
    const saveButton = document.getElementById('save-button');
    const formFields = document.querySelectorAll('#profile-form input[readonly], #profile-form select[readonly]');
    const profilePictureInput = document.querySelector('input[name="user[profile_picture]"]');
    const profilePicturePreview = document.getElementById('profile-picture-preview');

    editButton.addEventListener('click', function() {
      formFields.forEach(field => {
        if (field.name !== "user[email]" && field.name !== "user[role]" && field.name !== "details[status]") {
          field.removeAttribute('readonly');
        }
      });

      profilePictureInput.style.display = 'block';
      saveButton.style.display = 'block';
      editButton.style.display = 'none';
    });

    // Preview the uploaded profile picture
    profilePictureInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          profilePicturePreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    const availabilityStatusField = document.getElementById('availability_status_field');
  const availabilitySwitch = document.getElementById('availability-switch');

  if (availabilitySwitch && availabilityStatusField) {
    availabilitySwitch.addEventListener('change', function() {
      availabilityStatusField.value = this.checked ? 'available' : 'unavailable';
      document.getElementById('availability-status-form').requestSubmit(); // Trigger form submission
    });
  } else {
    console.error('Required elements not found.');
  }

   
  });
</script>
